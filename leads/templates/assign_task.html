{% extends "base.html" %}

{% block title %}Assign Task{% endblock %}

{% block extra_css %}
<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }
    .form-label { font-weight: 600; }
    textarea { resize: vertical; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Assign Task</h3>
        </div>
                <div id="thankYouMessage" 
            class="alert alert-success mt-3 text-center fw-bold" 
            style="display: none;">
            ✅ Task Assigned Successfully!
        </div>

        <div class="card-body">
            <form method="post" action="{% url 'assign_task' %}" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- DATE SECTION -->
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Assign Date</label>
                        <input type="date" name="assign_date" class="form-control" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Follow Up Date</label>
                        <input type="date" name="follow_up_date" class="form-control" required>
                    </div>
                </div>

                <!-- STATE & CITY -->
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">State</label>
                        <select id="stateSelect" name="state" class="form-select">
                            <option value="">Select State</option>
                            {% for state in states %}
                                <option value="{{ state }}">{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">City</label>
                        <select id="citySelect" name="city" class="form-select">
                            <option value="">Select City</option>
                        </select>
                    </div>
                </div>

                <!-- HOSPITAL -->
                <div class="row mb-3">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Hospital</label>
                        <select name="hospital_id" id="hospitalSelect" class="form-select" required>
                            <option value="">Select Hospital</option>
                        </select>
                    </div>
                </div>

                <!-- STAFF & TASK TYPE -->
                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Staff Member</label>
                        <select name="staff_id" class="form-select" required>
                            <option value="">Select Staff</option>
                            {% for person in staff %}
                                <option value="{{ person.id }}">{{ person.id }} - {{ person.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Task Type</label>
                       <select name="task_type" class="form-control" required>
                      <option value="">Select Task</option>
                      <option value="quotation_submitted">Quotation Submitted</option>
                      <option value="payment_follow_up">Payment follow up</option>
                      <option value="scrap_machine">Scrap Machine</option>
                      <option value="ncp_solution">NCP_Solution</option>
                      <option value="ncp_machine">NCP_Machine</option>
                      <option value="fmc_amc">FMC_AMC</option>
                      <option value="phone_call">Phone Call</option>
                      <option value="pts_visit">PTS_Visit</option>
                      <option value="citro_clear">Citro Clear</option>
                      <option value="pulmonary">Pulmonary</option>
                    </select>
                   
                    </div>
                </div>

                <!-- DESCRIPTION -->
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-control" rows="3" required></textarea>
                </div>

                <!-- REMARKS -->
                <div class="mb-3">
                    <label class="form-label">Remarks</label>
                    <textarea name="remarks" class="form-control" rows="3" required></textarea>
                </div>

                <!-- SUBMIT -->
                <div class="text-end">
                    <button class="btn btn-primary px-4" type="submit">Submit</button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const form = document.querySelector("form");
    const thankYou = document.getElementById("thankYouMessage");

    form.addEventListener("submit", function(e) {
        e.preventDefault();  // stop default reload

        let formData = new FormData(form);

        fetch("{% url 'assign_task' %}", {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                form.style.display = "none";
                thankYou.style.display = "block";

                setTimeout(() => {
                    window.location.href = "{% url 'manage_task' %}";
                }, 2000);
            }
        });
    });

});
</script>

<!-- DEPENDENT FILTERS: State → City → Hospital -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const stateSelect = document.getElementById("stateSelect");
    const citySelect = document.getElementById("citySelect");
    const hospitalSelect = document.getElementById("hospitalSelect");

    const hospitalData = [
        {% for h in hospitals %}
            {
                id: "{{ h.id }}",
                name: "{{ h.hospital_name }}",
                city: "{{ h.city|title }}",
                state: "{{ h.state|title }}"
            },
        {% endfor %}
    ];

    // STATE → CITY
    stateSelect.addEventListener("change", function () {
        const selectedState = this.value;

        citySelect.innerHTML = `<option value="">Select City</option>`;
        hospitalSelect.innerHTML = `<option value="">Select Hospital</option>`;

        if (!selectedState) return;

        const filteredCities = [...new Set(
            hospitalData.filter(h => h.state === selectedState)
                        .map(h => h.city)
        )];

        filteredCities.forEach(city => {
            citySelect.innerHTML += `<option value="${city}">${city}</option>`;
        });
    });

    // CITY → HOSPITAL
    citySelect.addEventListener("change", function () {
        const selectedCity = this.value;

        hospitalSelect.innerHTML = `<option value="">Select Hospital</option>`;

        hospitalData.filter(h => h.city === selectedCity)
            .forEach(h => {
                hospitalSelect.innerHTML +=
                    `<option value="${h.id}">${h.id} - ${h.name}</option>`;
            });
    });

});
</script>

{% endblock %}
